{% extends 'base.html' %}

{% block meta %}
<title>Register - Onif Sportswear</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
  <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
    <div class="max-w-md w-full relative z-10">
      <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">

        <div class="text-center mb-8">
          <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
          <p class="text-gray-500">Create your Onif Sportswear account</p>
        </div>

        <!-- Feedback umum -->
        <div id="form-feedback" class="hidden mb-4 text-center text-sm font-medium"></div>

        <!-- Form AJAX -->
        <form id="register-form" class="space-y-5" novalidate>
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
            <input id="username" type="text" required
                   class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition"
                   placeholder="Choose a username">
            <p id="err-username" class="mt-2 text-sm text-red-600 hidden"></p>
          </div>

          <div>
            <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input id="password1" type="password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition"
                   placeholder="Create a password">
            <p id="err-password1" class="mt-2 text-sm text-red-600 hidden"></p>
          </div>

          <div>
            <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
            <input id="password2" type="password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition"
                   placeholder="Confirm your password">
            <p id="err-password2" class="mt-2 text-sm text-red-600 hidden"></p>
          </div>

          <button type="submit" id="submit-btn"
                  class="w-full bg-green-600 text-white font-medium py-3 px-4 rounded hover:bg-green-700 transition">
            Create Account
          </button>
        </form>

        <!-- Loading -->
        <div id="loading" class="hidden mt-4 text-center">
          <svg class="animate-spin h-6 w-6 text-green-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <p class="text-gray-500 text-sm">Creating your account...</p>
        </div>

        <div class="mt-6 text-center">
          <p class="text-gray-500 text-sm">
            Already have an account?
            <a href="{% url 'main:login' %}" class="text-green-600 hover:text-green-700 font-medium">Sign In</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const REGISTER_URL = "{% url 'main:register' %}";
const LOGIN_URL = "{% url 'main:login' %}";

const form = document.getElementById('register-form');
const submitBtn = document.getElementById('submit-btn');
const loading = document.getElementById('loading');
const feedback = document.getElementById('form-feedback');

const errUser = document.getElementById('err-username');
const errPass1 = document.getElementById('err-password1');
const errPass2 = document.getElementById('err-password2');

function clearErrors() {
  [errUser, errPass1, errPass2].forEach(el => { el.textContent = ''; el.classList.add('hidden'); });
  feedback.textContent = ''; feedback.classList.add('hidden');
}

function showFieldError(el, msg) {
  el.textContent = Array.isArray(msg) ? msg.join(', ') : (msg || '');
  el.classList.remove('hidden');
}

function toggleLoading(state) {
  loading.classList.toggle('hidden', !state);
  submitBtn.disabled = state;
  form.classList.toggle('opacity-50', state);
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  clearErrors();

  const payload = {
    username: document.getElementById('username').value.trim(),
    password1: document.getElementById('password1').value,
    password2: document.getElementById('password2').value,
  };

  if (!payload.username || !payload.password1 || !payload.password2) {
    feedback.textContent = 'Please fill out all fields.';
    feedback.className = 'block text-center mb-4 text-sm font-medium text-red-600';
    return;
  }

  toggleLoading(true);

  try {
    const res = await fetch(REGISTER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (res.ok && data.success) {
      // ⬇️ Tanpa pesan sukses—langsung redirect ke halaman login
      window.location.href = LOGIN_URL;
      return;
    }

    // Tampilkan error dari form.errors
    const errs = data.errors || {};
    if (errs.username) showFieldError(errUser, errs.username);
    if (errs.password1) showFieldError(errPass1, errs.password1);
    if (errs.password2) showFieldError(errPass2, errs.password2);

    if (!errs.username && !errs.password1 && !errs.password2) {
      feedback.textContent = data.message || 'Registration failed.';
      feedback.className = 'block text-center mb-4 text-sm font-medium text-red-600';
    }
  } catch (err) {
    feedback.textContent = 'Network error. Please try again.';
    feedback.className = 'block text-center mb-4 text-sm font-medium text-red-600';
    console.error(err);
  } finally {
    toggleLoading(false);
  }
});
</script>
{% endblock content %}
